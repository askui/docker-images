name: Check and Build Latest From Dockerhub
on: workflow_dispatch

env:
  DOCKER_REPOSITORY: askui-docker-images-repository-playground
  ASKUI_VERSION: 0.13.1

jobs:
  check_latest_selenium_chrome_tags:
    name: Get latest selenium chrome tags
    runs-on: [ubuntu-latest]
    outputs:
      outputmatrix: ${{ steps.set-matrix.outputs.MATRIX_CONFIG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - id: set-matrix
        run: |
          curl -sL https://hub.docker.com/v2/repositories/selenium/standalone-chrome/tags\?page_size\=100 | jq -r '.results[] | select(.name | contains(".")) | .name | if contains("-") then split("-")[1] else . end | select(. | contains("."))' | sort -V -r -u | grep -Ev '(dev|latest|beta|for)' > tags.conf
          echo tags.conf
          JSON=$(while IFS= read -r line; do
                            jq -n --arg version $line '{"name":"chrome", "version":$version}'
                            done < "tags.conf" | jq -s .)
          echo $JSON | jq '.[]'
          JSON_STRING=$( jq -n --argjson json "$JSON" '$json')
          echo $JSON_STRING
          # TODO check for existence of image
          # - run: docker manifest inspect askuigmbh/${{ env.DOCKER_REPOSITORY }}:129.0
          echo "MATRIX_CONFIG={\"include\":$JSON_STRING"} >> $GITHUB_OUTPUT
  build_and_release_all_docker_images:
    strategy:
      max-parallel: 1
      matrix: ${{fromJson(needs.check_latest_selenium_chrome_tags.outputs.outputmatrix}}
    uses: ./.github/workflows/docker-images-base-workflow.yml
    with:
      version: ${{ env.ASKUI_VERSION }} ## askui version
      environment_name: ${{ matrix.name }} ## usually chrome
      environment_version: ${{ matrix.version }} ## chrome version
    secrets: inherit

